<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel - WhatsApp SN</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        #bannedUsersPanel {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 300px;
            max-height: 80vh;
            overflow-y: auto;
            background-color: #343a40;
            padding: 15px;
            border-radius: 8px;
            color: white;
        }
        #bannedUsersPanel h5 {
            border-bottom: 1px solid #777;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
    </style>
</head>

<body class="bg-dark text-light">

<nav th:replace="~{fragments/navbar.html :: navbar}"></nav>

<div class="container my-5">
    <h1 class="mb-4 text-center">Admin Panel</h1>

    <div id="reportContainer">
        <div class="text-center text-muted" id="noReportsMessage" th:if="${#lists.isEmpty(reportedMessages)}">
            No reported messages found.
        </div>

        <div class="row" id="reportList" th:each="msg : ${reportedMessages}">
            <div class="col-md-8 offset-md-2 mb-4">
                <div class="card bg-secondary-subtle text-dark border-0 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">
                            Message by <span th:text="${msg.sender.username}">Sender</span>
                        </h5>
                        <p class="card-text" th:text="${msg.content}">Message content</p>

                        <h6 class="mt-3">Reports:</h6>
                        <ul class="list-group list-group-flush mb-3">
                            <li class="list-group-item bg-light-subtle text-dark" th:each="r : ${msg.reports}">
                                <strong th:text="${r.reporter.username}">Reporter</strong>:
                                <span th:text="${r.reason}">Reason</span>
                            </li>
                        </ul>

                        <form th:action="@{/admin/dismiss-message-reports/{id}(id=${msg.id})}" method="post" class="mb-3">
                            <button type="submit" class="btn btn-outline-secondary btn-sm">Dismiss All Reports</button>
                        </form>

                        <form th:action="@{/admin/ban-user/{msgId}(msgId=${msg.id})}" method="post" class="d-flex gap-2">
                            <select name="duration" class="form-select form-select-sm w-auto">
                                <option value="24h">Ban 24h</option>
                                <option value="1w">Ban 1 week</option>
                                <option value="forever">Ban forever</option>
                            </select>
                            <button class="btn btn-danger btn-sm" type="submit">Ban User</button>
                        </form>

                        <div class="mt-2" th:if="${msg.sender.bannedUntil != null}">
                            <small class="text-danger">
                                User is banned until: <span th:text="${msg.sender.bannedUntil}"></span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Banned Users Panel -->
<div id="bannedUsersPanel">
    <h5>Banned Users</h5>
    <ul id="bannedUsersList" class="list-unstyled mb-0">
        <li class="text-muted">Loading...</li>
    </ul>
</div>

<footer th:replace="~{fragments/footer.html :: footer}"></footer>
<div th:insert="~{fragments/scripts.html :: bootstrapScript}"></div>

<script>
    async function fetchReports() {
        try {
            const response = await fetch('/admin/panel/reports');
            const data = await response.json();

            const reportContainer = document.getElementById('reportContainer');

            if (!data || data.length === 0) {
                reportContainer.innerHTML = '<div class="text-center text-muted">No reported messages found.</div>';
                return;
            }

            let html = '<div class="row">';
            data.forEach(msg => {
                html += `
                    <div class="col-md-8 offset-md-2 mb-4">
                        <div class="card bg-secondary-subtle text-dark border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">Message by <span>${msg.senderUsername}</span></h5>
                                <p class="card-text">${msg.content}</p>

                                <h6 class="mt-3">Reports:</h6>
                                <ul class="list-group list-group-flush mb-3">
                                    ${msg.reports.map(r => `
                                        <li class="list-group-item bg-light-subtle text-dark">
                                            <strong>${r.reporterUsername}</strong>: ${r.reason}
                                        </li>
                                    `).join('')}
                                </ul>

                                <form action="/admin/dismiss-message-reports/${msg.id}" method="post" class="mb-3">
                                    <button type="submit" class="btn btn-outline-secondary btn-sm">Dismiss All Reports</button>
                                </form>

                                <form action="/admin/ban-user/${msg.id}" method="post" class="d-flex gap-2">
                                    <select name="duration" class="form-select form-select-sm w-auto">
                                        <option value="24h">Ban 24h</option>
                                        <option value="1w">Ban 1 week</option>
                                        <option value="forever">Ban forever</option>
                                    </select>
                                    <button class="btn btn-danger btn-sm" type="submit">Ban User</button>
                                </form>

                                ${msg.bannedUntil ? `
                                    <div class="mt-2">
                                        <small class="text-danger">
                                            User is banned until: <span>${msg.bannedUntil}</span>
                                        </small>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            reportContainer.innerHTML = html;
        } catch (e) {
            console.error("Polling error (reports):", e);
        }
    }

    async function fetchBannedUsers() {
        try {
            const res = await fetch('/admin/panel/banned-users');
            const users = await res.json();

            const list = document.getElementById('bannedUsersList');
            if (!users || users.length === 0) {
                list.innerHTML = '<li class="text-muted">No currently banned users</li>';
                return;
            }

            list.innerHTML = '';
            users.forEach(u => {
                const bannedUntilText = u.bannedUntil ?
                    new Date(u.bannedUntil).toLocaleString() : 'Forever';

                list.innerHTML += `
                <li>
                    <strong>${u.username}</strong><br>
                    <small class="text-warning">Until: ${bannedUntilText}</small>
                </li>
                <hr>
            `;
            });
        } catch (err) {
            console.error("Polling error (banned users):", err);
            document.getElementById('bannedUsersList').innerHTML =
                '<li class="text-danger">Error loading banned users</li>';
        }
    }

    fetchReports();
    fetchBannedUsers();
    setInterval(fetchReports, 5000);
    setInterval(fetchBannedUsers, 5000);
</script>

</body>
</html>
