<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Home - WhatsApp</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body class="bg-dark text-light d-flex flex-column min-vh-100 background-wallpaper">
<th:block th:replace="~{fragments/navbar.html :: navbar}"/>
<div class="container my-5">
    <div class="row g-4 justify-content-center">
        <div class="col-md-4" sec:authorize="!hasRole('ADMIN')">
            <div class="card h-100 bg-secondary-subtle text-dark border-0 shadow-sm">
                <div class="card-body overflow-auto">
                    <h4 class="card-title mb-4">Recently Visited Chatrooms</h4>
                    <div th:if="${#lists.isEmpty(recentChatrooms)}" class="text-muted">
                        You havenâ€™t visited any chatrooms recently.
                    </div>
                    <div class="list-group" th:unless="${#lists.isEmpty(recentChatrooms)}">
                        <div th:each="chat : ${recentChatrooms}"
                             class="list-group-item d-flex justify-content-between align-items-center border-bottom bg-light-subtle text-dark">
                            <div>
                                <strong th:text="${displayNames[chat.id] ?: chat.name}">Chatroom Name</strong>
                                <span class="ms-2 badge"
                                      th:switch="${chat.type.name()}">
                                    <span th:case="'GROUP'" class="bg-info text-dark">Group</span>
                                    <span th:case="'COMMUNITY'" class="bg-success">Community</span>
                                    <span th:case="'PRIVATE'" class="bg-warning text-dark">Private</span>
                                    <span th:case="*" class="bg-secondary">Unknown</span>
                                </span>
                            </div>
                            <a th:href="@{/chatrooms/{id}/view-chatroom(id=${chat.id})}"
                               class="btn btn-outline-primary btn-sm">Chat</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 bg-secondary-subtle text-dark text-center border-0 shadow-sm">
                <div class="card-body d-flex flex-column justify-content-center">
                    <h4 class="card-title mb-4">Welcome!</h4>
                    <p><strong>Name:</strong> <span th:text="${name}"></span></p>
                    <p><strong>Email:</strong> <span th:text="${email}"></span></p>
                    <a href="/logout" class="btn btn-outline-danger mt-3">Logout</a>
                </div>
            </div>
        </div>
        <div class="col-md-4" id="broadcastCardContainer">
            <div th:replace="~{fragments/broadcast-card :: card(broadcasts=${broadcasts})}"></div>
        </div>
    </div>
</div>
<footer th:replace="~{fragments/footer.html :: footer}"></footer>
<div th:insert="~{fragments/scripts.html :: bootstrapScript}"></div>
<script th:inline="javascript">
    setInterval(async () => {
        try {
            const response = await fetch('/api/broadcasts');
            const html = await response.text();
            const parser = new DOMParser();
            const parsed = parser.parseFromString(html, 'text/html');

            const newCard = parsed.querySelector('[data-broadcast-card]');
            const container = document.getElementById('broadcastCardContainer');

            if (container && newCard) {
                container.innerHTML = '';
                container.appendChild(newCard);
            } else {
                console.warn('Unexpected response for broadcast polling. Skipping update.');
            }
        } catch (e) {
            console.error('Failed to poll broadcasts:', e);
        }
    }, 10000);
</script>
</body>
</html>
