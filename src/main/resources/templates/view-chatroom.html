<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Chatroom - WhatsApp SN</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/style.css" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>

<nav th:replace="~{fragments/navbar.html :: navbar}"></nav>

<div id="app-data"
     th:attr="data-current-user-id=${currentUserId}, data-current-user-name='${currentUserName}', data-chatroom-id=${chatroomId}">
</div>

<div class="chatbox-main">
    <div class="chat-toolbar">
        <div>
            <span class="chat-toolbar-title" th:text="${chatroomName}">Chatroom Name</span><br />
            <small class="text-light fst-italic" th:text="${chatroomType}">Chatroom Type</small>
        </div>
        <div>
            <a href="/chatrooms" class="btn btn-outline-light btn-sm">Back</a>
            <a th:href="@{/chatrooms/{id}/manage(id=${chatroomId})}" class="btn btn-outline-light btn-sm">Manage</a>
        </div>
    </div>

    <div class="chat-toolbar-users px-3 py-2 text-muted small">
        Online users: <span id="onlineUsers">Loading...</span>
    </div>

    <div class="chat-messages" id="chatBox">
        <div th:each="msg : ${messages}"
             th:class="'chat-message-row' + (${msg.senderName == currentUserName} ? ' me' : '')">
            <img class="chat-avatar" th:src="@{/img/bear.png}" th:if="${msg.senderName != currentUser}" alt="Avatar" />
            <div>
                <div class="chat-bubble">
                    <div th:if="${msg.file != null}">
                        <div th:if="${msg.file.mimeType != null}">
                            <div th:if="${#strings.startsWith(msg.file.mimeType, 'image/')}">
                                <img class="image-preview"
                                     th:src="@{/files/{id}/download(id=${msg.file.id})}" />
                            </div>
                        </div>
                        <a th:href="@{/files/{id}/download(id=${msg.file.id})}"
                           th:text="${msg.file.filename}" download></a>
                    </div>

                    <span class="sender-name" th:if="${msg.senderName != currentUser}" th:text="${msg.senderName}">Sender</span>
                    <div th:text="${msg.content}">Message content</div>
                    <div class="chat-meta" th:text="${#temporals.format(msg.timestamp, 'HH:mm')}">1/1/1970</div>

                    <i class="bi bi-exclamation-triangle-fill text-danger"
                       th:if="${reportedByMeIds.contains(msg.id)}"
                       title="This message has been reported">
                    </i>

                    <div class="text-end mt-1"
                         th:if="${msg.senderName != currentUserName and !reportedByMeIds.contains(msg.id)}">
                        <a th:href="@{'/reports/message/' + ${msg.id}}"
                           class="btn btn-sm btn-outline-danger">
                            Report
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form class="chat-input-area" enctype="multipart/form-data" method="post">
        <label class="file-label" title="Attach file">
            <svg width="23" height="23" fill="#a5d6a7" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" />
            </svg>
            <input type="file" name="file" class="d-none" />
        </label>
        <input type="text" name="message" placeholder="Type a message..." required maxlength="255" />
        <button type="submit" class="btn btn-success px-3">Send</button>
    </form>
    <span id="selectedFileName" class="ms-2 text-success small"></span>
    <div id="uploadSpinner" class="ms-2 text-muted small d-none">
        <div class="spinner-border spinner-border-sm text-secondary me-2" role="status"></div>
        Uploading file...
    </div>
</div>

<footer th:replace="~{fragments/footer.html :: footer}"></footer>

<script>
    const chatBox = document.getElementById("chatBox");
    if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const fileInput = document.querySelector('.chat-input-area input[type="file"]');
        const fileNameDisplay = document.getElementById('selectedFileName');

        fileInput.addEventListener('change', function () {
            if (fileInput.files.length > 0) {
                fileNameDisplay.textContent = fileInput.files[0].name;
            } else {
                fileNameDisplay.textContent = "";
            }
        });
    });
</script>

<script th:inline="javascript">
    const reportedByMeIds = /*[[${reportedByMeIds}]]*/ [];
    let fileUploading = false;

    function disableSendButton(disabled) {
        const sendBtn = document.querySelector('.chat-input-area button[type="submit"]');
        if (sendBtn) sendBtn.disabled = disabled;
    }
    let chatroomId = [[${chatroomId}]];
    let stompClient = null;

    function connect() {
        const socket = new SockJS('/chat');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {
            stompClient.subscribe(`/topic/messages/${chatroomId}`, function (messageOutput) {
                const msg = JSON.parse(messageOutput.body);
                showMessage(msg);
            });

            stompClient.subscribe(`/topic/presence/${chatroomId}`, function (presenceEvent) {
                const presence = JSON.parse(presenceEvent.body);
                showPresenceNotification(presence);
                fetchOnlineUsers();
                console.log("Presence update:", presence);
            });

            stompClient.send("/app/join", {}, JSON.stringify({ chatroomId: chatroomId }));

            fetchOnlineUsers();
        });
    }

    function showPresenceNotification(presence) {
        const currentUserName = document.getElementById('app-data').dataset.currentUserName;
        const user = presence.username;
        const type = presence.type;

        if (user === /*[[${currentUserName}]]*/ "defaultUser") {
            return;
        }

        const alertBox = document.createElement("div");
        alertBox.className = "alert alert-info text-center py-2";
        alertBox.textContent = `${user} has ${type === 'JOIN' ? 'joined' : 'left'} the chat`;

        const chatBox = document.getElementById("chatBox");
        chatBox.appendChild(alertBox);

        setTimeout(() => alertBox.remove(), 8000);
    }

    function fetchOnlineUsers() {
        fetch('/presence/online/chatroom/' + chatroomId)
            .then(response => response.json())
            .then(users => {
                const container = document.getElementById('onlineUsers');
                if (users.length === 0) {
                    container.textContent = "No one online";
                } else {
                    container.textContent = users.join(", ");
                }
            })
            .catch(err => {
                console.error("Failed to load online users", err);
            });
    }

    function showMessage(msg) {
        const currentUserId = document.getElementById('app-data').dataset.currentUserId;
        const isMe = String(msg.fromId) === String(currentUserId);
        const chatBox = document.getElementById("chatBox");

        const messageRow = document.createElement("div");
        messageRow.className = "chat-message-row" + (isMe ? " me" : "");

        const fileLink = msg.fileId && msg.filename
            ? msg.filename.endsWith('.jpg') || msg.filename.endsWith('.png') || msg.filename.endsWith('.jpeg') || msg.filename.endsWith('.gif')
                ? `<img class="image-preview" src="/files/${msg.fileId}/download"
                    style="max-width: 100px; max-height: 100px; margin-top: 0.5rem;" />`
                : `<a href="/files/${msg.fileId}/download" download>${msg.filename}</a>`
            : "";

        messageRow.innerHTML = `
        <img class="chat-avatar" src="/img/bear.png" alt="Avatar" />
        <div>
            <div class="chat-bubble">
                <span class="sender-name">${msg.from}</span>
                ${fileLink}
                <div>${msg.text}</div>
                <div class="chat-meta">${msg.time}</div>
                ${!isMe && !reportedByMeIds.includes(msg.id) ? `
                    <div class="text-end mt-1">
                        <a href="/reports/message/${msg.id}" class="btn btn-sm btn-outline-danger">Report</a>
                    </div>
                ` : ""}
            </div>
        </div>
    `;

        chatBox.appendChild(messageRow);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function uploadFile(file) {
        fileUploading = true;
        disableSendButton(true);
        document.getElementById('uploadSpinner').classList.remove('d-none');

        const formData = new FormData();
        formData.append("file", file);

        try {
            const response = await fetch(`/files/${chatroomId}/upload`, {
                method: "POST",
                body: formData
            });

            if (!response.ok) {
                throw new Error("File upload failed");
            }

            return await response.json();

        } finally {
            fileUploading = false;
            disableSendButton(false);
            document.getElementById('uploadSpinner').classList.add('d-none');
        }
    }

    async function sendMessageWithFile(messageText, file) {
        const currentUserId = document.getElementById('app-data').dataset.currentUserId;
        const currentUserName = document.getElementById('app-data').dataset.currentUserName;
        if (fileUploading) {
            alert("Please wait until the file finishes uploading.");
            return;
        }

        let fileData = null;
        if (file) {
            try {
                fileData = await uploadFile(file);
            } catch (err) {
                alert(err.message);
                return;
            }
        }

        const message = {
            fromId: currentUserId,
            from: currentUserName,
            text: messageText,
            time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            chatroomId: chatroomId,
            fileId: fileData?.fileId || null,
            filename: fileData?.filename || null
        };

        stompClient.send("/app/chat", {}, JSON.stringify(message));
    }

    document.addEventListener('DOMContentLoaded', function () {
        connect();

        const form = document.querySelector('.chat-input-area');
        const textInput = form.querySelector('input[name="message"]');
        const fileInput = form.querySelector('input[type="file"]');

        form.addEventListener('submit', async function (event) {
            event.preventDefault();

            const text = textInput.value.trim();
            const file = fileInput.files.length > 0 ? fileInput.files[0] : null;

            if (text.length === 0 && !file) return;

            await sendMessageWithFile(text, file);
            textInput.value = '';
            fileInput.value = '';
            document.getElementById('selectedFileName').textContent = '';
        });
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
