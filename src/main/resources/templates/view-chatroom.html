<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chatroom - WhatsApp SN</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f8f9fa;
        }
        .chat-toolbar {
            border-bottom: 1px solid #ececec;
            background: #fff;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .chat-toolbar-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #212121;
            letter-spacing: .02em;
        }
        .chatbox-main {
            max-width: 720px;
            margin: 2rem auto;
            box-shadow: 0 2px 12px rgba(80, 80, 80, 0.08);
            border-radius: 18px;
            background: #fff;
            display: flex;
            flex-direction: column;
            height: 80vh;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 2rem 1.5rem 1.5rem 1.5rem;
            background: #f7f8fa;
        }
        .chat-message-row {
            display: flex;
            align-items: flex-end;
            margin-bottom: 1.3rem;
        }
        .chat-message-row.me {
            flex-direction: row-reverse;
        }
        .chat-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: #d7f0e4;
            margin: 0 0.75rem;
            flex-shrink: 0;
            object-fit: cover;
        }
        .chat-bubble {
            max-width: 80%;
            background: #fff;
            border-radius: 18px;
            padding: 0.85rem 1.15rem 0.75rem 1.15rem;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
            position: relative;
            font-size: 1rem;
            color: #212121;
        }
        .chat-message-row.me .chat-bubble {
            background: #daf9e8;
        }
        .chat-meta {
            margin-top: 0.3rem;
            font-size: 0.76rem;
            color: #999;
            text-align: right;
        }
        .chat-toolbar-actions .btn {
            margin-left: 0.6rem;
        }
        /* Input area at bottom */
        .chat-input-area {
            border-top: 1px solid #ececec;
            background: #fff;
            padding: 0.7rem 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }
        .chat-input-area input[type="text"] {
            flex: 1;
            border-radius: 20px;
            border: 1px solid #e1e3e1;
            padding: 0.7rem 1.1rem;
            font-size: 1rem;
            background: #f8f8fa;
        }
        .chat-input-area input[type="file"] {
            display: none;
        }
        .file-label {
            margin: 0 0.5rem 0 0;
            cursor: pointer;
        }
        .chat-bubble span.sender-name {
            font-weight: 500;
            color: #388e3c;
            display: block;
            margin-bottom: 0.3rem;
        }
        .file-label input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>

<!-- NAVIGATION BAR -->
<nav th:replace="~{fragments/navbar.html :: navbar}"></nav>

<div class="chatbox-main">
    <!-- Toolbar/Header -->
    <div class="chat-toolbar">
        <span class="chat-toolbar-title" th:text="${chatroomName}">Chatroom Name</span>
        <div class="chat-toolbar-actions">
            <a href="/chatrooms" class="btn btn-outline-secondary btn-sm">Back</a>
            <a th:href="@{/chatrooms/{id}/manage(id=${chatroomId})}" class="btn btn-outline-primary btn-sm">Manage</a>
        </div>
    </div>

    <!-- Chat messages -->
    <div class="chat-messages" id="chatBox">
        <div th:each="msg : ${messages}"
             th:class="'chat-message-row' + (${msg.senderName == currentUser} ? ' me' : '')">
            <img class="chat-avatar"
                 th:src="@{../static/img/bear.png}" th:if="${msg.senderName != currentUser}"
                 alt="Avatar" />
            <div>
                <div class="chat-bubble" th:classappend="${msg.senderName == currentUser} ? ' me' : ''">
                    <div th:if="${msg.file != null}">
                        <img id="imagePreview" style="max-width: 100px; max-height: 100px; display: none; margin-left: 10px;" />
                        <a th:href="@{/chatrooms/files/{id}/download(id=${msg.file.id})}" th:text="${msg.file.filename}" download></a>
                    </div>
                    <span class="sender-name" th:if="${msg.senderName != currentUser}"
                          th:text="${msg.senderName}">Sender</span>
                    <div th:text="${msg.content}">Message content</div>
<!--                    <div th:if="${msg.fileName != null}">-->
<!--                        <a th:href="@{/files/{id}(id=${msg.fileId})}" th:text="${msg.fileName}" download></a>-->
<!--                    </div>-->
                    <div class="chat-meta" th:text="${#temporals.format(msg.timestamp, 'HH:mm')}">1/1/1970</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Message input area (combined text + file upload) -->
    <form class="chat-input-area" th:action="@{/chatrooms/{id}/send-message(id=${chatroomId})}"
          method="post" enctype="multipart/form-data" autocomplete="off">
        <!-- File attachment button -->
        <label class="file-label" title="Attach file">
            <svg width="23" height="23" fill="#3d8b60" viewBox="0 0 24 24"><path d="M17.657 6.343a8 8 0 10-11.314 11.314 8 8 0 0011.314-11.314zm-1.414 1.414a6 6 0 11-8.486 8.486 6 6 0 018.486-8.486zm-4.95 4.95a1 1 0 111.415 1.414l-2.122 2.121a1 1 0 01-1.414-1.415l2.121-2.12z"></path></svg>
            <input type="file" name="file">
        </label>
        <input type="text" name="message" placeholder="Type a message..." required maxlength="255">
        <small class="text-muted ms-2" style="font-size: 0.92em;">Max 255 characters</small>
        <button type="submit" class="btn btn-success px-3">Send</button>
    </form>
    <span id="selectedFileName" style="margin-left: 8px; color: #388e3c; font-size: 0.95em;"></span>
</div>


<footer th:replace="~{fragments/footer.html :: footer}"></footer>

<!-- Auto-scroll to bottom -->
<script>
    const chatBox = document.getElementById("chatBox");
    if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.querySelector('.chat-input-area input[type="file"]');
        const fileNameDisplay = document.getElementById('selectedFileName');
        const imagePreview = document.getElementById('imagePreview');
        if (fileInput && fileNameDisplay) {
            fileInput.addEventListener('change', function() {
                if (fileInput.files.length) {
                    fileNameDisplay.textContent = fileInput.files[0].name;
                    // Preview image if it's an image
                    if (imagePreview) {
                        const file = fileInput.files[0];
                        if (file && file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                imagePreview.src = e.target.result;
                                imagePreview.style.display = "inline-block";
                            }
                            reader.readAsDataURL(file);
                        } else {
                            imagePreview.src = "";
                            imagePreview.style.display = "none";
                        }
                    }
                } else {
                    fileNameDisplay.textContent = "";
                    if (imagePreview) {
                        imagePreview.src = "";
                        imagePreview.style.display = "none";
                    }
                }
            });
        }
    });
</script>
<div th:insert="fragments/scripts.html :: bootstrapScript"></div>
</body>
</html>
