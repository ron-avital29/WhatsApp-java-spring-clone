<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Chatroom - WhatsApp SN</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/style.css" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body class="bg-dark text-light d-flex flex-column min-vh-100 background-wallpaper">

<nav th:replace="~{fragments/navbar.html :: navbar}"></nav>

<div id="app-data"
     th:attr="data-current-user-id=${currentUserId},
              data-current-user-name=${currentUserName},
              data-chatroom-id=${chatroomId}">
</div>


<div class="chatbox-main">
    <div class="chat-toolbar">
        <div>
            <span class="chat-toolbar-title" th:text="${chatroomName}">Chatroom Name</span><br />
            <small class="text-light fst-italic" th:text="${chatroomType}">Chatroom Type</small>
        </div>
        <div>
            <a href="/chatrooms" class="btn btn-outline-light btn-sm">Back</a>
            <a th:href="@{/chatrooms/{id}/manage(id=${chatroomId})}" class="btn btn-outline-light btn-sm">Manage</a>
        </div>
    </div>

    <div class="chat-toolbar-users px-3 py-2 text-muted small">
        Online users: <span id="onlineUsers">Loading...</span>
    </div>

    <div class="chat-messages" id="chatBox">
        <div th:each="msg : ${messages}"
             th:class="'chat-message-row' + (${msg.senderName == currentUserName} ? ' me' : '')">
            <img class="chat-avatar" th:src="@{/img/bear.png}" th:if="${msg.senderName != currentUser}" alt="Avatar" />
            <div>
                <div class="chat-bubble">
                    <div th:if="${msg.file != null}">
                        <div th:if="${msg.file.mimeType != null}">
                            <div th:if="${#strings.startsWith(msg.file.mimeType, 'image/')}">
                                <img class="image-preview"
                                     th:src="@{/files/{id}/download(id=${msg.file.id})}" />
                            </div>
                        </div>
                        <a th:href="@{/files/{id}/download(id=${msg.file.id})}"
                           th:text="${msg.file.filename}" download></a>
                    </div>

                    <span class="sender-name" th:if="${msg.senderName != currentUser}" th:text="${msg.senderName}">Sender</span>
                    <div th:text="${msg.content}">Message content</div>
                    <div class="chat-meta" th:text="${#temporals.format(msg.timestamp, 'HH:mm')}">1/1/1970</div>

                    <i class="bi bi-exclamation-triangle-fill text-danger"
                       th:if="${reportedByMeIds.contains(msg.id)}"
                       title="This message has been reported">
                    </i>

                    <div class="text-end mt-1"
                         th:if="${msg.senderName != currentUserName and !reportedByMeIds.contains(msg.id)}">
                        <a th:href="@{'/reports/message/' + ${msg.id}}"
                           class="btn btn-sm btn-outline-danger">
                            Report
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form class="chat-input-area" enctype="multipart/form-data" method="post">
        <label class="file-label" title="Attach file">
            <svg width="23" height="23" fill="#a5d6a7" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" />
            </svg>
            <input type="file" name="file" class="d-none" />
        </label>
        <input type="text" name="message" placeholder="Type a message..." required maxlength="255" />
        <button type="submit" class="btn btn-success px-3">Send</button>
    </form>
    <span id="selectedFileName" class="ms-2 text-success small"></span>
    <div id="chatError" class="ms-2 text-danger small mt-1"></div>
    <div id="uploadSpinner" class="ms-2 text-muted small d-none">
        <div class="spinner-border spinner-border-sm text-secondary me-2" role="status"></div>
        Uploading file...
    </div>
</div>

<footer th:replace="~{fragments/footer.html :: footer}"></footer>

<!-- Auto-scroll to bottom -->
<script>
    const chatBox = document.getElementById("chatBox");
    if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
</script>

<!-- Show selected file name -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const fileInput = document.querySelector('.chat-input-area input[type="file"]');
        const fileNameDisplay = document.getElementById('selectedFileName');

        fileInput.addEventListener('change', function () {
            if (fileInput.files.length > 0) {
                fileNameDisplay.textContent = fileInput.files[0].name;
            } else {
                fileNameDisplay.textContent = "";
            }
        });
    });
</script>

<script th:inline="javascript">
    window.reportedByMeIds = /*[[${reportedByMeIds}]]*/ [];
</script>
<script src="/js/websocket.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
