<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Chatroom - WhatsApp SN</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            background: #f8f9fa;
        }
        .chat-toolbar {
            border-bottom: 1px solid #ececec;
            background: #fff;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .chat-toolbar-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #212121;
        }
        .chatbox-main {
            max-width: 720px;
            margin: 2rem auto;
            box-shadow: 0 2px 12px rgba(80, 80, 80, 0.08);
            border-radius: 18px;
            background: #fff;
            display: flex;
            flex-direction: column;
            height: 80vh;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 2rem 1.5rem 1.5rem 1.5rem;
            background: #f7f8fa;
        }
        .chat-message-row {
            display: flex;
            align-items: flex-end;
            margin-bottom: 1.3rem;
        }
        .chat-message-row.me {
            flex-direction: row-reverse;
        }
        .chat-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: #d7f0e4;
            margin: 0 0.75rem;
            object-fit: cover;
        }
        .chat-bubble {
            max-width: 100%;
            background: #fff;
            border-radius: 18px;
            padding: 0.85rem 1.15rem;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
            font-size: 1rem;
            color: #212121;
        }
        .chat-message-row.me .chat-bubble {
            background: #daf9e8;
        }
        .chat-meta {
            margin-top: 0.3rem;
            font-size: 0.76rem;
            color: #999;
            text-align: right;
        }
        .chat-input-area {
            border-top: 1px solid #ececec;
            background: #fff;
            padding: 0.7rem 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }
        .chat-input-area input[type="text"] {
            flex: 1;
            border-radius: 20px;
            border: 1px solid #e1e3e1;
            padding: 0.7rem 1.1rem;
            font-size: 1rem;
            background: #f8f8fa;
        }
        .file-label {
            margin: 0 0.5rem 0 0;
            cursor: pointer;
        }
        .chat-bubble span.sender-name {
            font-weight: 500;
            color: #388e3c;
            display: block;
            margin-bottom: 0.3rem;
        }
    </style>
</head>
<body>

<nav th:replace="~{fragments/navbar.html :: navbar}"></nav>

<div id="app-data"
     th:attr="data-current-user-id=${currentUserId}, data-current-user-name='${currentUserName}'"></div>

<div class="chatbox-main">
    <div class="chat-toolbar">
        <span class="chat-toolbar-title" th:text="${chatroomName}">Chatroom Name</span>
        <div class="chat-toolbar-actions">
            <a href="/chatrooms" class="btn btn-outline-secondary btn-sm">Back</a>
            <a th:href="@{/chatrooms/{id}/manage(id=${chatroomId})}" class="btn btn-outline-primary btn-sm">Manage</a>
        </div>
    </div>

    <div class="chat-messages" id="chatBox">
        <div th:each="msg : ${messages}"
             th:class="'chat-message-row' + (${msg.senderName == currentUser} ? ' me' : '')">
            <img class="chat-avatar" th:src="@{/img/bear.png}" th:if="${msg.senderName != currentUser}" alt="Avatar" />
            <div>
                <div class="chat-bubble">
                    <div th:if="${msg.file != null}">
                        <img class="image-preview" th:if="${msg.file != null} and ${msg.file.mimeType != null} and ${msg.file.mimeType.startsWith('image/')}"
                             th:src="@{/chatrooms/files/{id}/download(id=${msg.file.id})}"
                             style="max-width: 100px; max-height: 100px; margin-left: 10px;" />
                        <a th:href="@{/chatrooms/files/{id}/download(id=${msg.file.id})}"
                           th:text="${msg.file.filename}" download></a>
                    </div>
                    <span class="sender-name" th:if="${msg.senderName != currentUser}" th:text="${msg.senderName}">Sender</span>
                    <div th:text="${msg.content}">Message content</div>
                    <div class="chat-meta" th:text="${#temporals.format(msg.timestamp, 'HH:mm')}">1/1/1970</div>
                </div>
            </div>
        </div>
    </div>

    <form class="chat-input-area" enctype="multipart/form-data" method="post">
        <label class="file-label" title="Attach file">
            <svg width="23" height="23" fill="#3d8b60" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" />
            </svg>
            <input type="file" name="file" />
        </label>
        <input type="text" name="message" placeholder="Type a message..." required maxlength="255" />
        <button type="submit" class="btn btn-success px-3">Send</button>
    </form>
    <span id="selectedFileName" class="ms-2 text-success small"></span>
</div>

<footer th:replace="~{fragments/footer.html :: footer}"></footer>

<script>
    const chatBox = document.getElementById("chatBox");
    if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const fileInput = document.querySelector('.chat-input-area input[type="file"]');
        const fileNameDisplay = document.getElementById('selectedFileName');

        fileInput.addEventListener('change', function () {
            if (fileInput.files.length > 0) {
                fileNameDisplay.textContent = fileInput.files[0].name;
            } else {
                fileNameDisplay.textContent = "";
            }
        });
    });
</script>

<script th:inline="javascript">
    let chatroomId = [[${chatroomId}]];
    let stompClient = null;

    function connect() {
        const socket = new SockJS('/chat');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function () {
            stompClient.subscribe('/topic/messages', function (messageOutput) {
                const msg = JSON.parse(messageOutput.body);
                showMessage(msg);
            });
        });
    }

    function showMessage(msg) {
        const currentUserName = document.getElementById('app-data').dataset.currentUserName;
        const isMe = msg.from === currentUserName;
        const chatBox = document.getElementById("chatBox");

        const messageRow = document.createElement("div");
        messageRow.className = "chat-message-row" + (isMe ? " me" : "");

        const avatar = isMe ? "" : `<img class="chat-avatar" src="/img/bear.png" alt="Avatar" />`;

        const fileLink = msg.fileId && msg.filename
            ? msg.filename.endsWith('.jpg') || msg.filename.endsWith('.png') || msg.filename.endsWith('.jpeg') || msg.filename.endsWith('.gif')
                ? `<img class="image-preview" src="/chatrooms/files/${msg.fileId}/download"
                        style="max-width: 100px; max-height: 100px; margin-left: 10px;" />`
                : `<a href="/chatrooms/files/${msg.fileId}/download" download>${msg.filename}</a>`
            : "";

        messageRow.innerHTML = `
            ${avatar}
            <div>
                <div class="chat-bubble">
                    ${!isMe ? `<span class="sender-name">${msg.from}</span>` : ""}
                    ${fileLink}
                    <div>${msg.text}</div>
                    <div class="chat-meta">${msg.time}</div>
                </div>
            </div>
        `;

        chatBox.appendChild(messageRow);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function uploadFile(file) {
        const formData = new FormData();
        formData.append("file", file);

        const response = await fetch(`/chatrooms/${chatroomId}/upload`, {
            method: "POST",
            body: formData
        });

        if (!response.ok) {
            throw new Error("File upload failed");
        }

        return await response.json(); // returns { fileId, filename }
    }

    async function sendMessageWithFile(messageText, file) {
        const currentUserId = document.getElementById('app-data').dataset.currentUserId;
        const currentUserName = document.getElementById('app-data').dataset.currentUserName;

        let fileData = null;
        if (file) {
            try {
                fileData = await uploadFile(file);
            } catch (err) {
                alert(err.message);
                return;
            }
        }

        const message = {
            fromId: currentUserId,
            from: currentUserName,
            text: messageText,
            time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            chatroomId: chatroomId,
            fileId: fileData?.fileId || null,
            filename: fileData?.filename || null
        };

        stompClient.send("/app/chat", {}, JSON.stringify(message));
    }

    document.addEventListener('DOMContentLoaded', function () {
        connect();

        const form = document.querySelector('.chat-input-area');
        const textInput = form.querySelector('input[name="message"]');
        const fileInput = form.querySelector('input[type="file"]');

        form.addEventListener('submit', async function (event) {
            event.preventDefault();

            const text = textInput.value.trim();
            const file = fileInput.files.length > 0 ? fileInput.files[0] : null;

            if (text.length === 0 && !file) return;

            await sendMessageWithFile(text, file);
            textInput.value = '';
            fileInput.value = '';
            document.getElementById('selectedFileName').textContent = '';
        });
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
